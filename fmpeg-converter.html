
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç€è¦½å™¨ç‰ˆ FFmpeg è½‰æª”å·¥å…·</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl">
        <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">ğŸ–¼ï¸ + ğŸµ = ğŸ¬ å½±ç‰‡åˆæˆå™¨</h1>
        
        <div class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">1. é¸æ“‡åœ–ç‰‡ (.jpg/.png)</label>
                    <input type="file" id="image-upload" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">2. é¸æ“‡éŸ³æª” (.m4a/.mp3)</label>
                    <input type="file" id="audio-upload" accept="audio/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100"/>
                </div>
            </div>

            <button id="convert-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                é–‹å§‹è½‰æª” (Start FFmpeg)
            </button>

            <div id="status-area" class="hidden bg-gray-50 p-4 rounded-lg border border-gray-200 text-sm font-mono text-gray-600 max-h-40 overflow-y-auto">
                <p>ç­‰å¾…æŒ‡ä»¤...</p>
            </div>

            <div id="result-area" class="hidden text-center">
                <h3 class="text-lg font-bold text-gray-800 mb-2">ğŸ‰ è½‰æª”å®Œæˆï¼</h3>
                <video id="output-video" controls class="w-full rounded-lg shadow-md mb-4 bg-black"></video>
                <a id="download-link" class="inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full transition-colors">
                    ä¸‹è¼‰å½±ç‰‡
                </a>
            </div>
        </div>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        // åˆå§‹åŒ– FFmpeg å¯¦ä¾‹ (é–‹å•Ÿ log å¯ä»¥çœ‹åˆ°è©³ç´°é€²åº¦)
        const ffmpeg = createFFmpeg({ log: true });

        const imageInput = document.getElementById('image-upload');
        const audioInput = document.getElementById('audio-upload');
        const convertBtn = document.getElementById('convert-btn');
        const statusArea = document.getElementById('status-area');
        const resultArea = document.getElementById('result-area');
        const outputVideo = document.getElementById('output-video');
        const downloadLink = document.getElementById('download-link');

        const log = (message) => {
            statusArea.innerHTML += `<p>> ${message}</p>`;
            statusArea.scrollTop = statusArea.scrollHeight;
        };

        convertBtn.addEventListener('click', async () => {
            const imgFile = imageInput.files[0];
            const audioFile = audioInput.files[0];

            if (!imgFile || !audioFile) {
                alert('è«‹å…ˆé¸æ“‡åœ–ç‰‡å’ŒéŸ³æª”ï¼');
                return;
            }

            // UI ç‹€æ…‹æ›´æ–°
            convertBtn.disabled = true;
            convertBtn.innerText = "è½‰æª”ä¸­... (è«‹ç¨å€™ï¼Œé€™éœ€è¦ç€è¦½å™¨ç®—åŠ›)";
            statusArea.classList.remove('hidden');
            resultArea.classList.add('hidden');
            statusArea.innerHTML = ''; // æ¸…ç©º log

            try {
                // 1. è¼‰å…¥ FFmpeg æ ¸å¿ƒ (ç¬¬ä¸€æ¬¡æœƒæ¯”è¼ƒä¹…)
                if (!ffmpeg.isLoaded()) {
                    log('æ­£åœ¨è¼‰å…¥ FFmpeg core (ç´„ 20-30MB)...');
                    await ffmpeg.load();
                    log('FFmpeg è¼‰å…¥å®Œæˆï¼');
                }

                // 2. å°‡æª”æ¡ˆå¯«å…¥ FFmpeg çš„è™›æ“¬è¨˜æ†¶é«”ç³»çµ±
                const imgName = 'input_image.jpg';
                const audioName = 'input_audio.m4a';
                
                log('æ­£åœ¨è®€å–æª”æ¡ˆ...');
                ffmpeg.FS('writeFile', imgName, await fetchFile(imgFile));
                ffmpeg.FS('writeFile', audioName, await fetchFile(audioFile));

                // 3. åŸ·è¡Œè½‰æª”æŒ‡ä»¤
                // é€™æ˜¯ä½ åŸæœ¬çš„æŒ‡ä»¤å°æ‡‰åˆ° JS çš„å¯«æ³•
                // æŒ‡ä»¤: -loop 1 -i img -i audio -vf "scale=trunc(iw/2)*2:trunc(ih/2)*2" -c:v libx264 -tune stillimage -c:a copy -pix_fmt yuv420p -shortest output.mp4
                
                log('ğŸš€ å•Ÿå‹•æ¥µé™çœè³‡æºæ¨¡å¼ (1fps / 480p)...');
                
                await ffmpeg.run(
                    '-loop', '1',
                    // â˜… é—œéµä¿®æ”¹ 1: å°‡è¼¸å…¥åœ–ç‰‡çš„è®€å–é »ç‡è¨­ç‚º 1 fps
                    '-framerate', '1', 
                    '-i', imgName,
                    '-i', audioName,
                    
                    // â˜… é—œéµä¿®æ”¹ 2: å¼·åˆ¶ç¸®å°åˆ° 480p (854å¯¬)
                    // 12åˆ†é˜å¤ªé•·äº†ï¼Œç‚ºäº†ä¸å´©æ½°ï¼Œæˆ‘å€‘å¿…é ˆçŠ§ç‰²è§£æåº¦
                    '-vf', 'scale=854:-2', 
                    
                    '-c:v', 'libx264',
                    '-preset', 'ultrafast',
                    '-tune', 'stillimage',
                    
                    // â˜… é—œéµä¿®æ”¹ 3: å¼·åˆ¶è¼¸å‡ºå½±ç‰‡ç‚º 1 fps
                    // åŸæœ¬ 12åˆ†é˜ = 18,000 æ ¼
                    // ç¾åœ¨ 12åˆ†é˜ = 720 æ ¼ (è¨˜æ†¶é«”éœ€æ±‚å¤§æ¸›)
                    '-r', '1',
                    
                    // â˜… é—œéµä¿®æ”¹ 4: é™åˆ¶æµé‡åœ¨ 500k
                    '-b:v', '500k',
                    
                    '-c:a', 'copy',
                    '-pix_fmt', 'yuv420p',
                    '-shortest',
                    'output.mp4'
                );
/*                
                log('é–‹å§‹åŸ·è¡Œ FFmpeg æŒ‡ä»¤ (å·²å„ªåŒ–è¨˜æ†¶é«”)...');
                
                await ffmpeg.run(
                    '-loop', '1',
                    '-i', imgName,
                    '-i', audioName,
                    // â˜… ä¿®æ”¹ 1: å¼·åˆ¶ç¸®åœ–åˆ° 1280 å¯¬ (720p)ï¼Œé«˜åº¦è‡ªå‹•ç¶­æŒæ¯”ä¾‹ä¸”ç‚ºå¶æ•¸
                    '-vf', 'scale=1280:-2', 
                    
                    '-c:v', 'libx264',
                    
                    // â˜… ä¿®æ”¹ 2: ä½¿ç”¨æœ€å¿«é è¨­å€¼ (çœè¨˜æ†¶é«”)
                    '-preset', 'ultrafast', 
                    
                    '-tune', 'stillimage',
                    
                    // â˜… ä¿®æ”¹ 3: é™åˆ¶ä½å…ƒç‡ (é˜²æ­¢è¼¸å‡ºæª”æ¡ˆå¤ªå¤§æ’çˆ† RAM)
                    '-b:v', '1000k', 
                    
                    '-c:a', 'copy', 
                    '-pix_fmt', 'yuv420p',
                    '-shortest',
                    'output.mp4'
                );
/*                
                log('é–‹å§‹åŸ·è¡Œ FFmpeg æŒ‡ä»¤...');
                
                await ffmpeg.run(
                    '-loop', '1',
                    '-i', imgName,
                    '-i', audioName,
                    '-vf', 'scale=trunc(iw/2)*2:trunc(ih/2)*2', // è‡ªå‹•ä¿®å¾©å¥‡æ•¸åƒç´ 
                    '-c:v', 'libx264',
                    '-tune', 'stillimage',
                    '-c:a', 'copy', // ç›´æ¥è¤‡è£½éŸ³è¨Šæµï¼Œä¸é‡æ–°ç·¨ç¢¼ (é€Ÿåº¦å¿«)
                    '-pix_fmt', 'yuv420p',
                    '-shortest', // å½±ç‰‡é•·åº¦ä»¥æœ€çŸ­çš„ç‚ºä¸» (å³éŸ³è¨Šé•·åº¦)
                    'output.mp4'
                );
*/
                log('è½‰æª”å®Œæˆï¼æ­£åœ¨è™•ç†è¼¸å‡ºæª”æ¡ˆ...');

                // 4. è®€å–è¼¸å‡ºæª”æ¡ˆ
                const data = ffmpeg.FS('readFile', 'output.mp4');

                // 5. å»ºç«‹ Blob URL ä¾›é è¦½èˆ‡ä¸‹è¼‰
                const videoBlob = new Blob([data.buffer], { type: 'video/mp4' });
                const videoUrl = URL.createObjectURL(videoBlob);

                outputVideo.src = videoUrl;
                downloadLink.href = videoUrl;
                downloadLink.download = 'my_video.mp4';

                resultArea.classList.remove('hidden');
                log('âœ… å…¨éƒ¨å®Œæˆï¼');

            } catch (error) {
                console.error(error);
                log(`âŒ ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
                alert('è½‰æª”å¤±æ•—ï¼Œè«‹æŸ¥çœ‹ Console (F12) ç²å–è©³ç´°è³‡è¨Šï¼Œæˆ–ç¢ºèªæ˜¯å¦ä½¿ç”¨äº†æ”¯æ´ SharedArrayBuffer çš„ä¼ºæœå™¨ç’°å¢ƒã€‚');
            } finally {
                convertBtn.disabled = false;
                convertBtn.innerText = "é–‹å§‹è½‰æª” (Start FFmpeg)";
            }
        });
    </script>
</body>
</html>

